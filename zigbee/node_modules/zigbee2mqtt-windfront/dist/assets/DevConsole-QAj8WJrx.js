import{r as t,j as e,a4 as B,am as G,b as z,B as S,F as J,y as V,ai as K,W as O,a as D,E as H,an as X,S as Y,L as q,ao as Z,ap as R}from"./index-B9KSRkAy.js";import{T as M}from"./TextareaField-Busy2yTR.js";import{J as Q}from"./Json-C6OVoNML.js";import{I as P}from"./InputField-D8fYIAZ2.js";import{C as U,A as ee}from"./ClusterSinglePicker-DlPNbPK2.js";import{E as te}from"./EndpointPicker-wR5nrVyy.js";import"./envs-DFlyG_dH.js";import"./SelectField-CwoktH0d.js";const W=t.memo(o=>{const{message:n}=o;return e.jsx("div",{className:"mockup-code w-full",children:e.jsx("pre",{"data-prefix":"~",className:B[n.level],children:e.jsxs("code",{children:["[",n.timestamp,"] ",n.message]})})})}),se=[65,66,67,68];function ne(o){const{value:n,onChange:u,attribute:r,definition:i,...d}=o,b=se.includes(i.type)?"text":"number";return e.jsx("input",{type:b,value:n,onChange:f=>{const p=b==="number"?f.target.valueAsNumber:f.target.value;u(r,Number.isNaN(p)?void 0:p)},...d})}function ae(o){const{device:n,readDeviceAttributes:u,writeDeviceAttributes:r,lastLog:i}=o,[d,b]=t.useState(G(n.endpoints)??""),[f,p]=t.useState(""),[c,x]=t.useState([]),[h,N]=t.useState(""),{t:l}=z(["common","zigbee"]),k=t.useCallback(s=>{p(""),x([]),b(s.toString())},[]),E=t.useCallback(s=>{x([]),p(s)},[]),A=t.useCallback((s,w)=>{if(!c.find(y=>y.attribute===s)){const y=c.concat([{attribute:s,definition:w}]);x(y)}},[c]),a=t.useCallback(s=>{N(s.target.value)},[]),m=t.useCallback(async()=>{await u(n.ieee_address,d,f,c.map(s=>s.attribute),h)},[n.ieee_address,d,f,c,h,u]),_=t.useCallback(async()=>{await r(n.ieee_address,d,f,c)},[n.ieee_address,d,f,c,r]),j=t.useMemo(()=>c.length>0&&e.jsx("fieldset",{className:"fieldset gap-2 p-3 rounded-box shadow-md",children:c.map(({attribute:s,value:w="",definition:y})=>e.jsxs("div",{className:"join join-horizontal min-w-xs",children:[e.jsxs("label",{className:"input join-item",children:[s,e.jsx(ne,{value:w,attribute:s,definition:y,onChange:($,I)=>{const L=Array.from(c),T=L.find(F=>F.attribute===$);T&&(T.value=I),x(L)}})]}),e.jsx(S,{className:"btn btn-error btn-outline join-item",item:s,onClick:$=>{const I=c.filter(L=>L.attribute!==$);x(I)},children:e.jsx(J,{icon:V})})]},s))}),[c]),C=t.useMemo(()=>{const s=new Set;if(d){const w=n.endpoints[Number.parseInt(d,10)];if(w)for(const y of w.clusters.input)s.add(y)}return s},[n,d]),g=c.length===0||f==="",v=t.useMemo(()=>K(n),[n]);return d?e.jsxs("div",{className:"flex-1 flex flex-col gap-3",children:[e.jsx("h2",{className:"text-lg",children:l("zigbee:read_write_attributes")}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(te,{label:l("zigbee:endpoint"),values:v,value:d,onChange:k,required:!0}),e.jsx(U,{label:l("cluster"),clusters:C,value:f,onChange:E,required:!0}),e.jsx(ee,{label:l("attribute"),value:"",cluster:f,device:n,onChange:A}),e.jsx(P,{type:"text",name:"state_property",label:l("devConsole:state_property"),value:h,detail:`${l("optional")}. ${l("devConsole:state_property_info")}`,onChange:a})]}),j,e.jsxs("div",{className:"join join-horizontal",children:[e.jsx(S,{disabled:g||c.some(s=>!!s.value),className:"btn btn-success join-item",onClick:m,children:l("read")}),e.jsx(S,{disabled:g,className:"btn btn-error join-item",onClick:_,children:l("write")})]}),i&&e.jsx(W,{message:i})]}):e.jsx("span",{children:"No endpoints"})}const oe=o=>{const{device:n,lastLog:u}=o,{t:r}=z(["common","zigbee"]),[i,d]=t.useState(1),[b,f]=t.useState(""),[p,c]=t.useState(""),[x,h]=t.useState("{}"),{sendMessage:N}=t.useContext(O),l=D(a=>a.bridgeDefinitions),k=t.useMemo(()=>{if(!b||!p)return!1;try{const a=JSON.parse(x);if(typeof a!="object"||Array.isArray(a)&&a.length>0&&typeof a[0]!="object")return!1}catch{return!1}return!0},[x,b,p]),E=t.useMemo(()=>{const a=n.endpoints[i],m=new Set,_=new Set,j=new Set,C=new Set,g=new Set;if(a){for(const s of a.clusters.input)m.add(s),_.add(s);for(const s of a.clusters.output)m.add(s),j.add(s)}if(l.custom_clusters[n.friendly_name])for(const s in l.custom_clusters[n.friendly_name])m.has(s)||(m.add(s),C.add(s));for(const s in l.clusters)m.has(s)||g.add(s);return[{name:"input_clusters",clusters:_},{name:"output_clusters",clusters:j},{name:"custom_clusters",clusters:C},{name:"other_zcl_clusters",clusters:g}]},[n.friendly_name,n.endpoints,i,l]),A=t.useCallback(async()=>{let a=Number.parseInt(p,10);Number.isNaN(a)&&(a=p),await N(`${n.ieee_address}/${i}/set`,{command:{cluster:b,command:a,payload:JSON.parse(x)}})},[b,n.ieee_address,p,x,i,N]);return e.jsxs("div",{className:"flex-1 flex flex-col gap-3",children:[e.jsx("h2",{className:"text-lg",children:r("execute_command")}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(P,{type:"number",name:"endpoint",label:r("zigbee:endpoint"),min:1,max:255,value:i,onChange:a=>!!a.target.value&&d(a.target.valueAsNumber),required:!0}),e.jsx(U,{label:r("zigbee:cluster"),clusters:E,value:b,onChange:a=>{f(a)},required:!0}),e.jsx(P,{type:"text",name:"command",label:r("command"),value:p,placeholder:"state, color...",onChange:a=>c(a.target.value),pattern:"^\\d+|^\\w+",required:!0})]}),e.jsx(M,{name:"payload",label:r("payload"),rows:3,value:x,onChange:a=>h(a.target.value),className:"textarea validator w-full",required:!0}),e.jsx("div",{children:e.jsx(S,{onClick:A,disabled:!k,className:"btn btn-success",children:r("execute")})}),u&&e.jsx(W,{message:u})]})},re=/^(zhc:tz: Read result of |z2m: Publish 'set' 'read' to |z2m: Publish 'set' 'write' to |zhc:tz: Wrote )/,ie=t.memo(({device:o,externalDefinition:n})=>{const{t:u}=z("zigbee"),r=D(d=>d.bridgeInfo.zigbee_herdsman_converters.version),i={labels:"new device support",title:`[New device support] ${o.model_id} from ${o.manufacturer}`,body:`<!-- MAKE SURE THIS IS NOT ALREADY POSTED ${R.slice(0,-4)} -->

### Link

### What does/doesn't work with the external definition?

### Details
zigbee-herdsman-converters: \`${r}\`
software_build_id: \`${o.software_build_id}\`
date_code: \`${o.date_code}\`
endpoints:
\`\`\`json
${JSON.stringify(o.endpoints)}
\`\`\`

### External definition:
\`\`\`ts
${n}
\`\`\`
`};return e.jsx(q,{target:"_blank",rel:"noopener noreferrer",to:`${R}?${new URLSearchParams(i).toString()}`,className:"btn",children:u("request_support")})});function be({device:o}){const n=H(),{sendMessage:u}=t.useContext(O),{t:r}=z(["devConsole","common"]),i=D(m=>m.lastNonDebugLog),[d,b]=t.useState(),[f,p]=t.useState(),[c,x]=t.useState(!1),[h,N]=t.useState(!1),l=D(m=>m.generatedExternalDefinitions[o.ieee_address]);t.useEffect(()=>{x(!1)},[o]),t.useEffect(()=>{i&&(i.message.startsWith("zhc:tz: Invoked ")?p(i):re.test(i.message)&&b(i))},[i]);const k=t.useCallback(async(m,_,j,C,g)=>{const v={read:{cluster:j,attributes:C}};g&&(v.read.state_property=g),await u(`${m}/${_}/set`,v)},[u]),E=t.useCallback(async(m,_,j,C)=>{const g={write:{cluster:j,payload:{}}};for(const v of C)g.write.payload[v.attribute]=v.value;await u(`${m}/${_}/set`,g)},[u]),A=t.useCallback(async()=>{x(!0),await u("bridge/request/device/generate_external_definition",{id:o.ieee_address})},[u,o.ieee_address]),a=t.useCallback(()=>{n(X(o.friendly_name))},[n,o.friendly_name]);return e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex flex-row justify-center items-center gap-2",children:[l?o.supported?null:e.jsx(ie,{device:o,externalDefinition:l}):c?e.jsx("span",{className:"loading loading-infinity loading-xl"}):e.jsx(S,{className:"btn btn-primary",onClick:A,children:r("generate_external_definition")}),e.jsx(S,{item:!h,onClick:N,className:"btn btn-primary",children:r(h?"hide_definition":"show_definition")}),e.jsx(Y,{className:"btn btn-error",onClick:a,title:r("reset_frontend_state"),modalDescription:r("common:dialog_confirmation_prompt"),modalCancelLabel:r("common:cancel"),children:r("reset_frontend_state")})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(M,{name:"generated_external_definition",label:r("generated_external_definition"),value:l,className:"textarea w-full",rows:8,readOnly:!0}),e.jsx(q,{to:Z,target:"_blank",rel:"noreferrer",className:"link link-primary self-end",children:r("common:documentation")})]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(Q,{obj:o.definition??{},lines:12})]}),e.jsx("div",{className:"divider"}),e.jsxs("div",{className:"flex flex-row flex-wrap justify-evenly gap-4",children:[e.jsx(ae,{device:o,lastLog:d,readDeviceAttributes:k,writeDeviceAttributes:E}),e.jsx(oe,{device:o,lastLog:f})]})]})}export{be as default};
