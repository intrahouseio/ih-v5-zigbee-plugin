import{r as d,j as s,W as D,b as I,ah as A,ai as k,B as y,F as E,h as O,aj as P,a as B}from"./index-B9KSRkAy.js";import{D as T}from"./DevicePicker-BPQGOPp-.js";import{E as S}from"./EndpointPicker-wR5nrVyy.js";import"./envs-DFlyG_dH.js";import"./SelectField-CwoktH0d.js";const F=d.memo(o=>{const{clusters:n,onChange:a,label:l,value:t,disabled:e}=o,p=d.useCallback(r=>{const{checked:h,name:_}=r.target;let b=[...t];h?b.push(_):b=b.filter(v=>v!==_),a(b)},[a,t]),u=d.useMemo(()=>Array.from(n).sort((r,h)=>r.toString().localeCompare(h.toString())).map(r=>s.jsxs("label",{className:"label",title:r,children:[s.jsx("input",{className:"checkbox",type:"checkbox",checked:t.includes(r),name:r,value:r,onChange:p,disabled:e}),r]},r)),[n,p,t,e]);return s.jsxs("fieldset",{className:"fieldset",children:[l&&s.jsx("legend",{className:"fieldset-legend",children:l}),s.jsx("div",{className:"flex flex-row flex-wrap gap-2",children:u})]})}),U=(o,n,a)=>{const{target:l}=o;return l.type==="group"?a.find(t=>t.id===l.id):n.find(t=>t.ieee_address===l.ieee_address)},V=d.memo(o=>{const{devices:n,groups:a,device:l,rule:t}=o,[e,p]=d.useState({rule:t}),{sendMessage:u}=d.useContext(D),{t:r}=I(["common","zigbee"]);d.useEffect(()=>{p({rule:t})},[t]);const h=d.useCallback(i=>{e.rule.source.endpoint=i,p({rule:e.rule})},[e.rule]),_=d.useCallback(i=>{i&&(A(i)?e.rule.target={type:"endpoint",ieee_address:i.ieee_address,endpoint:""}:e.rule.target={type:"group",id:i.id},e.rule.clusters=[],p({rule:e.rule}))},[e.rule]),b=d.useCallback(i=>{e.rule.target.type==="endpoint"&&(e.rule.target.endpoint=i,e.rule.clusters=[],p({rule:e.rule}))},[e.rule]),v=d.useCallback(i=>{e.rule.clusters=i,p({rule:e.rule})},[e.rule]),N=d.useCallback(async i=>{let g="",x;const{target:c}=e.rule;if(c.type==="group"){const m=a.find(C=>C.id===c.id);if(m)g=m.id;else{console.error("Target group does not exist:",c.id);return}}else if(c.type==="endpoint"){const m=n.find(C=>C.ieee_address===c.ieee_address);if(m)g=m.ieee_address,m.type!=="Coordinator"&&(x=c.endpoint);else{console.error("Target device does not exist:",c.ieee_address);return}}const f={from:l.ieee_address,from_endpoint:e.rule.source.endpoint,to:g,to_endpoint:x,clusters:e.rule.clusters};i==="Bind"?await u("bridge/request/device/bind",f):await u("bridge/request/device/unbind",f)},[l,e.rule,u,n,a]),$=d.useMemo(()=>k(l),[l]),j=U(e.rule,n,a),M=d.useMemo(()=>k(j),[j]),R=d.useMemo(()=>{const i=new Set(e.rule.clusters),g=l.endpoints[e.rule.source.endpoint],x=e.rule.target.type==="endpoint"&&e.rule.target.endpoint!=null?j?.endpoints[e.rule.target.endpoint]:void 0,c=e.rule.target.type==="group"||j?.type==="Coordinator";if(g&&(x||c))for(const f of[...g.clusters.input,...g.clusters.output])if(c)i.add(f);else{const m=g.clusters.input.includes(f)&&x?.clusters.output.includes(f),C=g.clusters.output.includes(f)&&x?.clusters.input.includes(f);(m||C||c)&&i.add(f)}return i},[l.endpoints,e,j]),w=d.useMemo(()=>{let i=!1;return e.rule.target.type==="endpoint"?i=!!(e.rule.source.endpoint&&e.rule.target.ieee_address&&e.rule.target.endpoint&&e.rule.clusters.length>0):e.rule.target.type==="group"&&(i=!!(e.rule.source.endpoint&&e.rule.target.id&&e.rule.clusters.length>0)),i},[e]);return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[s.jsx(S,{label:r("source_endpoint"),disabled:!e.rule.isNew,values:$,value:e.rule.source.endpoint,onChange:h}),s.jsx(T,{label:r("destination"),disabled:!e.rule.isNew,value:"ieee_address"in e.rule.target?e.rule.target.ieee_address:e.rule.target.id,devices:n,groups:a,onChange:_}),e.rule.target.type==="endpoint"?s.jsx(S,{label:r("destination_endpoint"),disabled:!e.rule.isNew,values:M,value:e.rule.target.endpoint,onChange:b}):null,s.jsx("div",{className:"grow w-128",children:s.jsx(F,{label:r("clusters"),clusters:R,value:e.rule.clusters,onChange:v})}),s.jsxs("fieldset",{className:"fieldset",children:[s.jsx("legend",{className:"fieldset-legend",children:r("actions")}),s.jsxs("div",{className:"join join-horizontal",children:[s.jsxs(y,{item:"Bind",disabled:!w,title:r("bind"),className:"btn btn-primary join-item",onClick:N,children:[s.jsx(E,{icon:O}),r("bind")," "]}),s.jsxs(y,{item:"Unbind",disabled:e.rule.isNew||!w,title:r("unbind"),className:"btn btn-error join-item",onClick:N,children:[s.jsx(E,{icon:P})," ",r("unbind")]})]})]})]}),s.jsx("div",{className:"divider"})]})}),q=o=>`${o.isNew}-${o.source.endpoint}-${o.source.ieee_address}-${"ieee_address"in o.target?o.target.ieee_address:o.target.id}-${o.clusters.join("-")}`,z=o=>{const n={};for(const a in o.endpoints){const l=o.endpoints[a];for(const t of l.bindings){let e="ieee_address"in t.target?`${t.target.ieee_address}-${t.target.endpoint}`:t.target.id;e=`${e}-${a}`,n[e]?n[e].clusters.push(t.cluster):n[e]={source:{ieee_address:o.ieee_address,endpoint:a},target:t.target,clusters:[t.cluster]}}}return Object.values(n)};function J(o){const{device:n}=o,a=B(u=>u.devices),l=B(u=>u.groups),[t,e]=d.useState({isNew:!0,target:{type:"endpoint",ieee_address:"",endpoint:""},source:{ieee_address:n.ieee_address,endpoint:""},clusters:[]}),p=d.useMemo(()=>z(n),[n]);return d.useEffect(()=>{e({isNew:!0,target:{type:"endpoint",ieee_address:"",endpoint:""},source:{ieee_address:n.ieee_address,endpoint:""},clusters:[]})},[n.ieee_address]),s.jsx("div",{className:"flex flex-col",children:[...p,t].map(u=>s.jsx(V,{rule:u,groups:l,device:n,devices:a},q(u)))})}export{J as default};
